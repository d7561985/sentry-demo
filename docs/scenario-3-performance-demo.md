# Scenario 3: Performance Monitoring Demo Guide

## –û–±–∑–æ—Ä

Scenario 3 –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ Sentry –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –≤—ã—è–≤–ª–µ–Ω–∏—é —É–∑–∫–∏—Ö –º–µ—Å—Ç –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ. 

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

1. **N+1 Query Problem** (User Service)
2. **CPU Spike** (Game Engine) 
3. **Slow MongoDB Aggregation** (Analytics Service)
4. **External API Latency** (Payment Service - —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)

## üöÄ –ó–∞–ø—É—Å–∫ –¥–µ–º–æ

### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã:
```bash
./start.sh
# –∏–ª–∏
docker-compose up -d
```

2. –û—Ç–∫—Ä–æ–π—Ç–µ frontend: http://localhost:4200

3. –û—Ç–∫—Ä–æ–π—Ç–µ Sentry Dashboard –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **Performance**

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Debug Panel

1. –í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ —Å–ª–æ—Ç-–º–∞—à–∏–Ω—ã –Ω–∞–∂–º–∏—Ç–µ **"üêõ Show Debug Panel"**
2. –ù–∞–π–¥–∏—Ç–µ —Å–µ–∫—Ü–∏—é **"Performance Issues"**

## üìä –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 1. N+1 Query Problem

**–ß—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ–º**: –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î

**–ö–∞–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏**:
1. –í Debug Panel –Ω–∞–∂–º–∏—Ç–µ **"üêå Trigger N+1 Query"**
2. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (5-10 —Å–µ–∫—É–Ω–¥)

**–ß—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å –≤ Sentry**:
1. Performance ‚Üí –Ω–∞–π–¥–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é `user.get_history`
2. –û—Ç–∫—Ä–æ–π—Ç–µ Trace View
3. –ü–æ–∫–∞–∂–∏—Ç–µ:
   - Span `db.query.history` —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏
   - 20+ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ `db.query.single_game`
   - –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∑–∞–Ω–∏–º–∞–µ—Ç 50ms+
   - –û–±—â–µ–µ –≤—Ä–µ–º—è: 1-2 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ 20 –∑–∞–ø–∏—Å–µ–π

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã**:
- "–í–º–µ—Å—Ç–æ 1 –∑–∞–ø—Ä–æ—Å–∞ - –¥–µ–ª–∞–µ–º 21 (1 –¥–ª—è IDs + 20 –¥–ª—è –∫–∞–∂–¥–æ–π –∏–≥—Ä—ã)"
- "–í production —Å —Ç—ã—Å—è—á–∞–º–∏ –∏–≥—Ä —ç—Ç–æ –∑–∞–π–º–µ—Ç –º–∏–Ω—É—Ç—ã"
- "–†–µ—à–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å —Å $in –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º"

### 2. CPU Spike (Prime Number Generation)

**–ß—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ–º**: –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è, –Ω–∞–≥—Ä—É–∂–∞—é—â–∏–µ CPU

**–ö–∞–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏**:
1. –í Debug Panel –Ω–∞–∂–º–∏—Ç–µ **"üî• Trigger CPU Spike"**
2. –ñ–¥–∏—Ç–µ ~5-10 —Å–µ–∫—É–Ω–¥

**–ß—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å –≤ Sentry**:
1. Performance ‚Üí –Ω–∞–π–¥–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é `game.calculate`
2. –û—Ç–∫—Ä–æ–π—Ç–µ –¥–µ—Ç–∞–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
3. –ü–æ–∫–∞–∂–∏—Ç–µ:
   - Span `cpu.prime_generation` (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥)
   - Span `cpu.heavy_calculation` —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∏—Ç–µ—Ä–∞—Ü–∏–π
   - –û–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è 5-10 —Å–µ–∫—É–Ω–¥

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã**:
- "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Å—Ç—ã—Ö —á–∏—Å–µ–ª –Ω–∞—á–∏–Ω–∞—è —Å 1,000,000"
- "30,000+ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è RNG"
- "–ë–ª–æ–∫–∏—Ä—É–µ—Ç event loop –≤ Python"
- "–í production —ç—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ timeout"

### 3. Slow MongoDB Aggregation

**–ß—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ–º**: –ù–µ–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã aggregation

**–ö–∞–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏**:
1. –í Debug Panel –Ω–∞–∂–º–∏—Ç–µ **"üìä Trigger Slow Analytics"**
2. –ñ–¥–∏—Ç–µ ~5-15 —Å–µ–∫—É–Ω–¥

**–ß—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å –≤ Sentry**:
1. Performance ‚Üí –Ω–∞–π–¥–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é `analytics.daily_stats`
2. –û—Ç–∫—Ä–æ–π—Ç–µ Trace View
3. –ü–æ–∫–∞–∂–∏—Ç–µ:
   - Span `db.aggregate` —Å —Ç–µ–≥–æ–º `performance.issue: missing_index`
   - Full collection scan –Ω–∞ –ø–æ–ª–µ timestamp
   - 5 —Å—Ç–∞–¥–∏–π aggregation pipeline
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è running totals

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã**:
- "–ù–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ –Ω–∞ –ø–æ–ª–µ timestamp"
- "Full collection scan –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞"
- "–°–ª–æ–∂–Ω—ã–π pipeline —Å $addFields –∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è–º–∏"
- "–†–µ—à–µ–Ω–∏–µ: compound index –Ω–∞ (timestamp, user_id)"

### 4. –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π

**–î–ª—è –ø–æ–ª–Ω–æ–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ distributed tracing**:

1. –°–¥–µ–ª–∞–π—Ç–µ –æ–±—ã—á–Ω—ã–π —Å–ø–∏–Ω (–∫–Ω–æ–ø–∫–∞ SPIN)
2. –ó–∞—Ç–µ–º –≤—ã–∑–æ–≤–∏—Ç–µ N+1 query
3. –ü–æ–∫–∞–∂–∏—Ç–µ –≤ Sentry –∫–∞–∫ –≤—Å–µ —Å–≤—è–∑–∞–Ω–æ –≤ –æ–¥–Ω–æ–º trace

## üéØ –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –¥–µ–º–æ

### Transaction Summary
- **p50**: <100ms (–Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
- **p95**: >1s (—Å performance issues)
- **p99**: >5s (CPU spike scenarios)

### Database Queries
- N+1 pattern: 20+ queries –≤–º–µ—Å—Ç–æ 1
- Missing indexes: full collection scans
- Query time: 50-500ms per query

### Custom Measurements
–í –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–∫–∞–∑–∞–Ω—ã:
- `analytics.days_processed`
- `analytics.total_games`
- `db.queries_executed`
- `cpu.calculations_performed`

## üìù Talking Points

### –ü—Ä–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ N+1:
> "–≠—Ç–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ ORM, –Ω–æ –∑–¥–µ—Å—å –º—ã —Å–¥–µ–ª–∞–ª–∏ –µ—ë –≤—Ä—É—á–Ω—É—é –¥–ª—è –¥–µ–º–æ. –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ Django/SQLAlchemy –º–æ–≥—É—Ç —Å–∫—Ä—ã—Ç—å —Ç–∞–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã. Sentry —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω."

### –ü—Ä–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ CPU Spike:
> "–ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –º–æ–∂–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å —Å–µ—Ä–≤–∏—Å. –í–∏–¥–∏–º —Ç–æ—á–Ω–æ –∫–∞–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤–∏–Ω–æ–≤–∞—Ç–∞ –∏ —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ —Ç—Ä–∞—Ç–∏—Ç—Å—è."

### –ü—Ä–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ Slow Aggregation:
> "MongoDB aggregation –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –Ω–æ –±–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å bottleneck. Sentry –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞–∫–∏–µ –∏–º–µ–Ω–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ –º–µ–¥–ª–µ–Ω–Ω—ã–µ."

## üîß –†–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º

### N+1 Query Fix:
```python
# –ü–ª–æ—Ö–æ: –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–∞–∂–¥–æ–π –∏–≥—Ä—ã
for game_id in game_ids:
    game = collection.find_one({"_id": game_id})

# –•–æ—Ä–æ—à–æ: –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
games = collection.find({"_id": {"$in": game_ids}})
```

### CPU Spike Fix:
```python
# –ü–ª–æ—Ö–æ: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Å—Ç—ã—Ö —á–∏—Å–µ–ª –¥–ª—è RNG
primes = generate_large_primes()

# –•–æ—Ä–æ—à–æ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π random
result = random.choice(symbols)
```

### Slow Aggregation Fix:
```python
# –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å
collection.create_index([("timestamp", 1), ("user_id", 1)])

# –£–ø—Ä–æ—Å—Ç–∏—Ç—å pipeline
# –£–±—Ä–∞—Ç—å –ª–∏—à–Ω–∏–µ $addFields
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å $project —Ä–∞–Ω—å—à–µ
```

## üé¨ –°—Ü–µ–Ω–∞—Ä–∏–π –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ (5-7 –º–∏–Ω—É—Ç)

1. **–í—Å—Ç—É–ø–ª–µ–Ω–∏–µ** (30 —Å–µ–∫)
   - "–ü–æ–∫–∞–∂—É –∫–∞–∫ Sentry –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"
   - "3 —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–∞ –∏–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏"

2. **N+1 Demo** (2 –º–∏–Ω)
   - –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
   - –ü–æ–∫–∞–∑–∞—Ç—å –≤ Sentry
   - –û–±—ä—è—Å–Ω–∏—Ç—å impact

3. **CPU Spike Demo** (2 –º–∏–Ω)
   - –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
   - –ü–æ–∫–∞–∑–∞—Ç—å spans
   - –û–±—Å—É–¥–∏—Ç—å —Ä–µ—à–µ–Ω–∏—è

4. **Slow Aggregation Demo** (2 –º–∏–Ω)
   - –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
   - –ü–æ–∫–∞–∑–∞—Ç—å missing index
   - –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

5. **–í—ã–≤–æ–¥—ã** (30 —Å–µ–∫)
   - "–ë–µ–∑ Sentry –ø–æ–∏—Å–∫ —Ç–∞–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –∑–∞–Ω—è–ª –±—ã —á–∞—Å—ã"
   - "–í–∏–¥–∏–º —Ç–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ –∏ –ø—Ä–∏—á–∏–Ω—É"
   - "–ú–æ–∂–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏"

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫** –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ - –¥–∞–π—Ç–µ —Å–∏—Å—Ç–µ–º–µ "–ø—Ä–æ–≥—Ä–µ—Ç—å—Å—è"
2. **Analytics Service** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω (–ø–æ—Ä—Ç 8084)
3. **MongoDB** –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ aggregation
4. Performance issues –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ** —á–µ—Ä–µ–∑ Debug Panel